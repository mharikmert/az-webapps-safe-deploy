name: Build & Tag Action

on:
  push:
    branches: ["master", "test"]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- 1. Calculate Next Version (Dry Run) ---
      - name: Calculate Version
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: master
          pre_release_branches: test
          default_bump: patch
          default_prerelease_bump: false
          dry_run: true

      - name: Set New Tag
        run: |
          echo "NEW_TAG=${{ steps.tag_version.outputs.new_tag }}" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # --- 2. Build the Action ---
      - name: Install & Build
        run: |
          npm ci
          npm run build

      # --- 3. Package & Tag the Build Artifact ---
      - name: Deploy Build Tag
        run: |
          # Git Config
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Force add the compiled action
          git add -f dist/index.js

          # Check if build changed anything (optional safety)
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è No changes in dist/ detected."
          fi

          # Create the "Build Commit" (detached from history)
          git commit -m "Build artifacts for $NEW_TAG"

          echo "üè∑Ô∏è Tagging build: $NEW_TAG"

          # Handle existing tags (if re-running/updating an RC)
          git tag -d "$NEW_TAG" || true
          git push origin ":refs/tags/$NEW_TAG" || true

          # Push the new tag pointing to the built artifacts
          git tag -a "$NEW_TAG" -m "Build artifacts for $NEW_TAG"
          git push origin "$NEW_TAG"

          # Update the major version tag (v2) to point here too
          if [[ "$NEW_TAG" != *"-"* ]]; then
             NEW_MAJOR_TAG="${NEW_TAG%%.*}" # Extract v2 from v2.1.0
             echo "Updating major tag: $NEW_MAJOR_TAG"
             git tag -f "$NEW_MAJOR_TAG"
             git push origin "$NEW_MAJOR_TAG" -f
          fi

      - name: If branch is master, create a release with the tag
        if: github.ref == 'refs/heads/master'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.NEW_TAG }}
          name: ${{ env.NEW_TAG }}
          body: ${{ steps.tag_version.outputs.changelog }}
